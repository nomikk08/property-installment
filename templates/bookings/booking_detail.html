{% extends "base.html" %}
{% load math_filters %}
{% block content %}

<div class="max-w-7xl mx-auto py-10 px-6">
  <a
    href="{% url 'bookings_page' %}"
    class="text-blue-600 hover:underline mb-4 inline-block"
    >‚Üê Back to Bookings</a
  >

  <!-- üîπ Remaining Balance Summary -->
  <div
    class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded"
  >
    <p class="text-lg font-medium">
      üí∞ <strong>Remaining Balance:</strong>
      Rs {{ booking.plot.price|subtract:booking.total_paid_amount }}
    </p>
  </div>

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">
      Booking #{{ booking.id }} ‚Äî {{ booking.plot.title }}
    </h1>
    <a
      href="{% url 'download_booking_pdf' booking.id %}"
      class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 transition"
    >
      üìÑ Download PDF
    </a>
  </div>

  <!-- üßæ MAIN GRID -->
  <div class="grid md:grid-cols-3 gap-6 mb-10">
    <!-- BOOKING DETAILS -->
    <div class="bg-white shadow-md p-6 rounded-lg border">
      <h2 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">
        Booking Details
      </h2>
      <p><strong>Booking Date:</strong> {{ booking.booking_date|date:"M d, Y" }}</p>
      <p><strong>Installment Months:</strong> {{ booking.installment_months }}</p>
      <p><strong>Monthly Installment:</strong> Rs {{ booking.monthly_installment }}</p>
      <p><strong>Down Payment:</strong> Rs {{ booking.down_payment_amount }}</p>
      <p><strong>Total Paid:</strong> Rs {{ booking.total_paid_amount }}</p>
      <p><strong>Remaining Months:</strong> {{ booking.remaining_installments }}</p>
      <p><strong>Notes:</strong> {{ booking.notes|default:"‚Äî" }}</p>
      <p class="mt-2">
        <strong>Status:</strong>
        {% if booking.is_completed %}
        <span class="px-2 py-1 text-sm bg-green-100 text-green-700 rounded">‚úÖ Completed</span>
        {% else %}
        <span class="px-2 py-1 text-sm bg-yellow-100 text-yellow-700 rounded">‚è≥ In Progress</span>
        {% endif %}
      </p>
    </div>

    <!-- PLOT DETAILS -->
    <div class="bg-white shadow-md p-6 rounded-lg border">
      <h2 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">
        Plot Details
      </h2>
      <p><strong>Plot No:</strong> {{ booking.plot.title }}</p>
      <p><strong>Location:</strong> {{ booking.plot.location }}</p>
      <p><strong>Type:</strong> {{ booking.plot.plot_type|title }}</p>
      <p><strong>Block:</strong> {{ booking.plot.block_name|default:"‚Äî" }}</p>
      <p><strong>Facing Direction:</strong> {{ booking.plot.facing_direction|default:"‚Äî" }}</p>
      <p><strong>Corner Plot:</strong> {{ booking.plot.is_corner|yesno:"Yes,No" }}</p>
      <p><strong>Size (L √ó W):</strong> {{ booking.plot.length_ft }}ft √ó {{ booking.plot.width_ft }}ft</p>
      <p><strong>Total Area:</strong> {{ booking.plot.size_sqft }} sqft</p>
      <p><strong>Price per Sqft:</strong> Rs {{ booking.plot.price_per_sqft }}</p>
      <p><strong>Total Price:</strong> Rs {{ booking.plot.price }}</p>
      <p><strong>Status:</strong> {{ booking.plot.get_status_display }}</p>
    </div>

    <!-- BUYER DETAILS -->
    <div class="bg-white shadow-md p-6 rounded-lg border">
      <h2 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">
        Buyer Details
      </h2>
      <p><strong>Name:</strong> {{ booking.buyer.name }}</p>
      <p><strong>Father's Name:</strong> {{ booking.buyer.father_name|default:"‚Äî" }}</p>
      <p><strong>CNIC:</strong> {{ booking.buyer.cnic }}</p>
      <p><strong>Contact:</strong> {{ booking.buyer.contact_no }}</p>
      <p><strong>Address:</strong> {{ booking.buyer.address|default:"‚Äî" }}</p>
      <p><strong>Inheritor:</strong> {{ booking.buyer.inheritor|default:"‚Äî" }}</p>
      <p><strong>Inheritor CNIC:</strong> {{ booking.buyer.inheritor_cnic|default:"‚Äî" }}</p>
      <p><strong>Relation:</strong> {{ booking.buyer.inheritor_relation|default:"‚Äî" }}</p>
    </div>
  </div>

  <!-- üí≥ PAYMENT SCHEDULE -->
   <h2 class="text-xl font-semibold mb-4">Payment Schedule</h2>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border rounded-lg shadow text-sm">
      <thead>
        <tr class="bg-gray-100 uppercase text-left">
          <th class="py-3 px-4">#</th>
          <th class="py-3 px-4">Due Date</th>
          <th class="py-3 px-4">Amount</th>
          <th class="py-3 px-4">Paid Date</th>
          <th class="py-3 px-4">Received By</th>
          <th class="py-3 px-4">Source</th>
          <th class="py-3 px-4">Status</th>
          <th class="py-3 px-4 text-center">Action</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for payment in payments %}
        <tr class="{% if payment == next_due %}bg-yellow-50{% elif payment.is_paid %}bg-green-50{% endif %}">
          <td class="py-3 px-4">{{ forloop.counter }}</td>

          {% if payment == next_due %}
          <!-- Editable Fields -->
          <form method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="payment_id" value="{{ payment.id }}">

            <td class="py-3 px-4">
              <input type="date" name="due_date" value="{{ payment.due_date|date:'Y-m-d' }}" class="border rounded p-1 w-full">
            </td>

            <td class="py-3 px-4">
              <input type="number" step="0.01" name="amount" value="{{ payment.amount }}" class="border rounded p-1 w-full">
            </td>

            <td class="py-3 px-4 text-gray-500">‚Äî</td>

            <td class="py-3 px-4">
              <select name="received_by" class="border rounded p-1 w-full">
                <option value="">‚Äî Select ‚Äî</option>
                <option value="tasawur" {% if payment.received_by == 'tasawur' %}selected{% endif %}>Tasawur</option>
                <option value="abdul_ghafoor" {% if payment.received_by == 'abdul_ghafoor' %}selected{% endif %}>Abdul Ghafoor</option>
              </select>
            </td>

            <td class="py-3 px-4">
              <select name="payment_source" class="border rounded p-1 w-full">
                <option value="">‚Äî Select Source ‚Äî</option>
                  {% for src in payment_sources %}
                    <option value="{{ src.id }}" {% if payment.source_id == src.id %}selected{% endif %}>{{ src.name }}</option>
                  {% endfor %}
              </select>
            </td>

            <td class="py-3 px-4 text-yellow-700 font-medium">Next Due ‚ö†</td>

            <td class="py-3 px-4 text-center">
              <button type="submit" name="save" class="bg-blue-500 text-white text-xs px-3 py-1 rounded hover:bg-blue-600">üíæ Save</button>
              <button type="submit" name="mark_paid" class="bg-green-600 text-white text-xs px-3 py-1 rounded hover:bg-green-700 ml-1">‚úÖ Mark Paid</button>
            </td>
          </form>
          {% else %}
          <!-- Readonly Fields -->
          <td class="py-3 px-4">{{ payment.due_date|date:"M d, Y" }}</td>
          <td class="py-3 px-4">Rs {{ payment.amount }}</td>
          <td class="py-3 px-4">{{ payment.paid_date|default:"‚Äî" }}</td>
          <td class="py-3 px-4">{{ payment.get_received_by_display|default:"‚Äî" }}</td>
          <td class="py-3 px-4">{{ payment.source.name|default:"-" }}</td>
          <td class="py-3 px-4">
            {% if payment.is_paid %}
              <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">Paid ‚úÖ</span>
            {% else %}
              <span class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded">Pending ‚è≥</span>
            {% endif %}
          </td>
          <td class="py-3 px-4 text-center text-gray-400">‚Äî</td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="8" class="py-4 text-center text-gray-500">No payments found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
